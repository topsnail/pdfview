<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PDF 预览 - 增强版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { margin: 0; background: #525659; font-family: sans-serif; overflow-x: hidden; }
        /* 工具栏样式优化，支持更多按钮 */
        .toolbar { 
            position: fixed; top: 0; width: 100%; background: #323639; 
            color: white; padding: 10px; display: flex; justify-content: center; 
            gap: 10px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            flex-wrap: wrap; /* 适配移动端换行 */
        }
        .canvas-container { 
            margin-top: 80px; /* 增加顶部间距防止遮挡 */
            display: flex; flex-direction: column; align-items: center; 
            padding-bottom: 20px;
        }
        canvas { box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-bottom: 20px; }
        button { 
            cursor: pointer; padding: 5px 12px; border-radius: 4px; 
            border: 1px solid #444; background: #4a4a4a; color: white;
            font-size: 13px;
        }
        button:hover { background: #666; }
        #page-info { font-size: 14px; line-height: 28px; min-width: 80px; text-align: center; }
        .divider { width: 1px; height: 20px; background: #555; align-self: center; }
    </style>
</head>
<body>
    <div class="toolbar">
        <button onclick="prevPage()">上一页</button>
        <span id="page-info"><span id="page-num">0</span> / <span id="page-count">0</span></span>
        <button onclick="nextPage()">下一页</button>
        
        <div class="divider"></div>

        <button onclick="zoomOut()">缩小 -</button>
        <button onclick="zoomIn()">放大 +</button>
        <button onclick="fitWidth()">适应窗口</button>
        <button onclick="fitHeight()">适应页面</button>

        <div class="divider"></div>
        
        <button onclick="window.close()" style="background: #883333;">关闭</button>
    </div>

    <div class="canvas-container">
        <canvas id="pdf-render"></canvas>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const url = urlParams.get('file');
        
        let pdfDoc = null;
        let pageNum = 1;
        let currentScale = 1.5; // 默认缩放比例
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');

        // 配置 PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        if (url) {
            pdfjsLib.getDocument({
                url: url,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true, // 支持中文和公式
            }).promise.then(doc => {
                pdfDoc = doc;
                document.getElementById('page-count').textContent = doc.numPages;
                renderPage(pageNum);
            }).catch(err => {
                console.error(err);
                alert("PDF加载失败，请检查链接或跨域(CORS)设置。");
            });
        }

        // 核心渲染函数
        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: currentScale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
                document.getElementById('page-num').textContent = num;
            });
        }

        // 翻页逻辑
        function prevPage() { if (pageNum <= 1) return; pageNum--; renderPage(pageNum); }
        function nextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; renderPage(pageNum); }

        // --- 缩放逻辑 ---

        // 放大
        function zoomIn() {
            currentScale += 0.2;
            renderPage(pageNum);
        }

        // 缩小
        function zoomOut() {
            if (currentScale <= 0.5) return;
            currentScale -= 0.2;
            renderPage(pageNum);
        }

        // 适应窗口（适应宽度）
        function fitWidth() {
            pdfDoc.getPage(pageNum).then(page => {
                // 计算比例：(窗口宽度 - 边距) / PDF原始宽度
                const viewport = page.getViewport({ scale: 1 });
                currentScale = (window.innerWidth - 40) / viewport.width;
                renderPage(pageNum);
            });
        }

        // 适应页面（适应高度）
        function fitHeight() {
            pdfDoc.getPage(pageNum).then(page => {
                // 计算比例：(窗口高度 - 工具栏高度 - 边距) / PDF原始高度
                const viewport = page.getViewport({ scale: 1 });
                currentScale = (window.innerHeight - 120) / viewport.height;
                renderPage(pageNum);
            });
        }

        // 监听窗口大小变化（可选：自动调整）
        window.onresize = () => {
            // 如果需要窗口改变时自动重绘，可以解除下面注释
            // if(pdfDoc) renderPage(pageNum);
        };
    </script>
</body>
</html>
